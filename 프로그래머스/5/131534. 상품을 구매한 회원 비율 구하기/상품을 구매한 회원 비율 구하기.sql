WITH USER2021 AS(
    SELECT *
    FROM USER_INFO
    WHERE TO_CHAR(JOINED,'YYYY') ='2021'
),
SALES2022 AS(
    SELECT *
    FROM ONLINE_SALE
    WHERE TO_CHAR(SALES_DATE,'YYYY') ='2022'
)
SELECT
    YEAR,
    MONTH,
    COUNT(DISTINCT USER_ID) AS PURCHASED_USERS,
    to_number(to_char(ROUND(
        COUNT(DISTINCT USER_ID) /
        (
            SELECT COUNT(DISTINCT USER_ID)
            FROM USER2021
        ), 1
    ), 'FM9990.0')) AS PUCHASED_RATIO
FROM
    (
        SELECT
            EXTRACT(YEAR FROM SALES_DATE) YEAR,
            EXTRACT(MONTH FROM SALES_DATE) MONTH,
            U.USER_ID
        FROM SALES2022 O , USER2021 U
        WHERE O.USER_ID = U.USER_ID
    )
GROUP BY YEAR , MONTH
ORDER BY YEAR, MONTH;



